
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Breaking the Vigenère Cipher - Random code</title>
  <meta name="author" content="Jose A. Garcia">

  
  <meta name="description" content="In my previous post I explained
how the Vigenère cipher works and how to implement it in Rust. I also mentioned that nowadays this
cipher doesn&rsquo &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jagg.github.io/blog/2016/09/14/breaking-the-vigenere-cipher/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Random code" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Random code</a></h1>
  
    <h2>Ruminations about random stuff.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="jagg.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Breaking the Vigenère Cipher</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-09-14T21:19:45+01:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>9:19 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>In my <a href="https://jagg.github.io/blog/2016/09/03/encrypting-like-its-1553/">previous post</a> I explained
how the Vigenère cipher works and how to implement it in Rust. I also mentioned that nowadays this
cipher doesn&rsquo;t offer any security, since it can be easly broken with the help of a computer. Well,
that is exactly what we are going to do now.</p>

<h2>The algorithm</h2>

<p>There are several methods to break Vigenère, usually the outline is:</p>

<ol>
<li><p>Guess the length of the key. There are several probabilistical methods, the main ones, the
Kasiski examination and the Friedman test are described in <a href="https://en.wikipedia.org/wiki/Vigen%C3%A8re_cipher#Cryptanalysis">Wikipedia</a>.</p></li>
<li><p>Once we have a likely key length we group all the characters from the cipher text that
are encrypted with each character in the key. So, for example, if the key has size three, we make
three groups, one with the characters in position 1, 4, 7, 11 &hellip;, another with the ones at 2, 5,
8&hellip; and so on, because all of them would have been encrypted using the same charater of the key.</p></li>
<li><p>Each of the groups from before are encrypted using the same character, this is a
<a href="https://en.wikipedia.org/wiki/Caesar_cipher">Caesar cipher</a>.
To solve it we can just try all the 256 possible values (all the possible values for a byte) and
pick the one that &ldquo;looks better&rdquo; according to some scoring function.</p></li>
</ol>


<p>Also, this particular problem is one of the cryptopals challenges, their instructions about how
to solve it are quite good, you can find them <a href="https://cryptopals.com/sets/1/challenges/6">here</a>.</p>

<h2>The implementation</h2>

<p>Now that we know all the parts of the project, let&rsquo;s start from the top and write what we need.</p>

<h3>Guessing the key size</h3>

<p>This is the most difficult bit. There are several alternatives and all of them are probabilistic,
so we will have to get a set of the best candidates and try them all. We could even try brute
force and test every possible key size until we find one that works.</p>

<p>The alternative described in cryptopals looks fairly easy to implement, so we could start there
and see how well it works.</p>

<p>The idea is to try different key sizes. For each key size K, take the first and second groups of
K bytes from the cipher text and calculate how &ldquo;different&rdquo; they are using the
<a href="https://en.wikipedia.org/wiki/Hamming_distance">Hamming distance</a> and normalizing the result
divinding by K. The key size with the smallest normalized result is likely to be the key. The
description from crytopals mentions that you could take more than two blocks and average the
results to improve the accuracy of the guess.</p>

<p>The truth is that I don&rsquo;t understand very well why this method works (I guess that since you are
repeating the same key, the blocks are more likely to be similar if they match the key size). I
implemented it and, while it worked with the cryptopals challenge file, it didn&rsquo;t guess very
well some of my own encrypted files.</p>

<p>This is my implementation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">fn</span> <span class="n">guess_key_size</span><span class="p">(</span><span class="n">cipher</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">cipher</span><span class="o">::</span><span class="n">CipherText</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">heap</span> <span class="o">=</span> <span class="n">BinaryHeap</span><span class="o">::</span><span class="n">new</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">best</span> <span class="o">=</span> <span class="n">Vec</span><span class="o">::</span><span class="n">new</span><span class="p">();</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mf">1.</span><span class="p">.</span><span class="mi">40</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">score</span> <span class="o">=</span> <span class="n">calc_size_score</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipher</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">(),</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'>        <span class="n">heap</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">KeyScore</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">size</span><span class="o">:</span> <span class="n">i</span> <span class="k">as</span> <span class="kt">u32</span><span class="p">,</span>
</span><span class='line'>            <span class="n">score</span><span class="o">:</span> <span class="n">score</span><span class="p">,</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="kd">let</span> <span class="nb">Some</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">=</span> <span class="n">heap</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">best</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
</span><span class='line'>            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">best</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">calc_size_score</span><span class="p">(</span><span class="n">cipher</span><span class="o">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">],</span> <span class="n">size</span><span class="o">:</span> <span class="kt">i32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">f32</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">b1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cipher</span><span class="p">[</span><span class="mf">0.</span><span class="p">.</span><span class="n">size</span> <span class="k">as</span> <span class="n">usize</span><span class="p">];</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">b2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cipher</span><span class="p">[</span><span class="n">size</span> <span class="k">as</span> <span class="n">usize</span><span class="p">..</span><span class="mi">2</span> <span class="o">*</span> <span class="n">size</span> <span class="k">as</span> <span class="n">usize</span><span class="p">];</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">b3</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cipher</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">size</span> <span class="k">as</span> <span class="n">usize</span><span class="p">..</span><span class="mi">3</span> <span class="o">*</span> <span class="n">size</span> <span class="k">as</span> <span class="n">usize</span><span class="p">];</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">b4</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cipher</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">size</span> <span class="k">as</span> <span class="n">usize</span><span class="p">..</span><span class="mi">4</span> <span class="o">*</span> <span class="n">size</span> <span class="k">as</span> <span class="n">usize</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">let</span> <span class="n">d1</span> <span class="o">=</span> <span class="n">hamming_dist</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">)</span> <span class="k">as</span> <span class="kt">f32</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">hamming_dist</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b3</span><span class="p">)</span> <span class="k">as</span> <span class="kt">f32</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">d3</span> <span class="o">=</span> <span class="n">hamming_dist</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b4</span><span class="p">)</span> <span class="k">as</span> <span class="kt">f32</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">d4</span> <span class="o">=</span> <span class="n">hamming_dist</span><span class="p">(</span><span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">)</span> <span class="k">as</span> <span class="kt">f32</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">d5</span> <span class="o">=</span> <span class="n">hamming_dist</span><span class="p">(</span><span class="n">b2</span><span class="p">,</span> <span class="n">b4</span><span class="p">)</span> <span class="k">as</span> <span class="kt">f32</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">d6</span> <span class="o">=</span> <span class="n">hamming_dist</span><span class="p">(</span><span class="n">b3</span><span class="p">,</span> <span class="n">b4</span><span class="p">)</span> <span class="k">as</span> <span class="kt">f32</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="p">((</span><span class="n">d1</span> <span class="o">+</span> <span class="n">d2</span> <span class="o">+</span> <span class="n">d3</span> <span class="o">+</span> <span class="n">d4</span> <span class="o">+</span> <span class="n">d5</span> <span class="o">+</span> <span class="n">d6</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">size</span> <span class="k">as</span> <span class="kt">f32</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The code returns the three most likely sizes so that we can test them all.</p>

<h3>Grouping the characters</h3>

<p>The logic behind this is not too difficult, but it will be easier to isolate this bit so that it
can be tested independently. So we start with the cipher text, a vector of bytes. If we look at
them as ASCII characters for a moment, we will have something meaningless like:</p>

<p>V: <code>wjmzbfapk</code></p>

<p>Now, if our key size is three, we want to break it down into three vectors:</p>

<p>V1: <code>wza</code>
V2: <code>jbp</code>
V3: <code>mfk</code></p>

<p>We now that V1 was encrypted with the first byte of the key, V2 with the second and so on. Now
we would run our brute force decryption function (described in the next section) and reassemble the
output again into a single vector:</p>

<p>V': <code>whizzbang</code></p>

<p>To represent this we can use a struct, keeping the byte vector and the size of the key we are trying
as fields.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">struct</span> <span class="n">ByteMatrix</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">matrix</span><span class="o">:</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;&gt;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">row_size</span><span class="o">:</span> <span class="n">usize</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We will need some operations to transpose the contents and to reassemble the result into a single
vector again.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">fn</span> <span class="n">to_matrix</span><span class="p">(</span><span class="n">vector</span><span class="o">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">],</span> <span class="n">size</span><span class="o">:</span> <span class="n">usize</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ByteMatrix</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">let</span> <span class="k">mut</span> <span class="n">vectors</span><span class="o">:</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="n">Vec</span><span class="o">::</span><span class="n">new</span><span class="p">();</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="mf">1.</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">vectors</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">Vec</span><span class="o">::</span><span class="n">new</span><span class="p">());</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">byte</span><span class="p">)</span> <span class="k">in</span> <span class="n">vector</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">enumerate</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">vectors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">size</span><span class="p">].</span><span class="n">push</span><span class="p">(</span><span class="o">*</span><span class="n">byte</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ByteMatrix</span> <span class="p">{</span>
</span><span class='line'>     <span class="n">matrix</span><span class="o">:</span> <span class="n">vectors</span><span class="p">,</span>
</span><span class='line'>     <span class="n">row_size</span><span class="o">:</span> <span class="n">size</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">pub</span> <span class="k">fn</span> <span class="n">reassemble</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">let</span> <span class="k">mut</span> <span class="n">bytes</span><span class="o">:</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">Vec</span><span class="o">::</span><span class="n">new</span><span class="p">();</span>
</span><span class='line'>  <span class="kd">let</span> <span class="n">max_size</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="p">();</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mf">0.</span><span class="p">.</span><span class="n">max_size</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="mf">0.</span><span class="p">.</span><span class="bp">self</span><span class="p">.</span><span class="n">row_size</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">let</span> <span class="n">this_size</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">matrix</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">len</span><span class="p">();</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">this_size</span> <span class="o">&gt;</span> <span class="n">i</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">bytes</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">matrix</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">bytes</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can deal with each row independently but we still need a way to transform the data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">fn</span> <span class="n">transform</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span> <span class="n">fun</span><span class="o">:</span> <span class="n">F</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ByteMatrix</span>
</span><span class='line'>  <span class="n">where</span> <span class="n">F</span><span class="o">:</span> <span class="n">FnMut</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">let</span> <span class="n">vecs</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">matrix</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="n">fun</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span>
</span><span class='line'>  <span class="n">ByteMatrix</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">matrix</span><span class="o">:</span> <span class="n">vecs</span><span class="p">,</span>
</span><span class='line'>      <span class="n">row_size</span><span class="o">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">row_size</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Breaking the Caesar cipher</h3>

<p>And now the last step. We have several byte vectors encoded using a single byte (Caesar cipher), so
we are going to try each possible key value and see which one of the outputs makes sense!
Obviously we are not going to print them all and pick ourselves, we need a scoring function to
pick one for us.</p>

<p>There are many ways to score the deciphered text, one common way is to check the frequency of each
character for your particular language and see how well your text follows the distribution. For our
purposes we don&rsquo;t need to do anything that complicated. Since we know that most of the text is going
to be made of lowercase latin characters we can add one to the score every time we found one. We
also know that there are a few others that are very unlikely, so we reduce the score by one when
we find them.</p>

<p>This is one possible scoring function we could use:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">score</span><span class="p">(</span><span class="n">input</span><span class="o">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kt">u32</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">input</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">fold</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">|</span><span class="n">acc</span><span class="p">,</span> <span class="n">b</span><span class="o">|</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">*</span><span class="n">b</span> <span class="o">&gt;=</span> <span class="mi">97</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">b</span> <span class="o">&lt;=</span> <span class="mi">122</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">acc</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">*</span><span class="n">b</span> <span class="o">&gt;=</span> <span class="mi">33</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">b</span> <span class="o">&lt;=</span> <span class="mi">64</span> <span class="o">&amp;&amp;</span> <span class="n">acc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">acc</span> <span class="o">-</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">acc</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we use this function with each one of our candidates:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">fn</span> <span class="n">decode_single_key</span><span class="p">(</span><span class="n">cipher</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">cipher</span><span class="o">::</span><span class="n">CipherText</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cipher</span><span class="o">::</span><span class="n">PlainText</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">plain</span> <span class="o">=</span> <span class="nb">None</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">best_score</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">key</span> <span class="k">in</span> <span class="mf">0.</span><span class="p">..</span><span class="mi">255_</span><span class="k">u8</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">candidate</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">::</span><span class="n">decrypt_single_key</span><span class="p">(</span><span class="n">cipher</span><span class="p">,</span> <span class="n">key</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="p">(</span><span class="o">&amp;</span><span class="n">candidate</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_score</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span><span class="p">;</span>
</span><span class='line'>            <span class="n">plain</span> <span class="o">=</span> <span class="nb">Some</span><span class="p">(</span><span class="n">candidate</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">plain</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note the inclusive range in the for loop, that is an unstable feature in rust, so we need to include
<code>#![feature(inclusive_range_syntax)]</code> in the definition of our module.</p>

<h3>Putting it all together</h3>

<p>Now we have all the pieces, let&rsquo;s use them to break the cipher!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">fn</span> <span class="n">break_cipher</span><span class="p">(</span><span class="n">cipher</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">cipher</span><span class="o">::</span><span class="n">CipherText</span><span class="p">,</span> <span class="n">key_size</span><span class="o">:</span> <span class="kt">u32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cipher</span><span class="o">::</span><span class="n">PlainText</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">matrix</span> <span class="o">=</span> <span class="n">byte_matrix</span><span class="o">::</span><span class="n">ByteMatrix</span><span class="o">::</span><span class="n">to_matrix</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipher</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">(),</span> <span class="n">key_size</span> <span class="k">as</span> <span class="n">usize</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="o">|</span><span class="n">vec</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;|</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">cipher</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">::</span><span class="n">CipherText</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="n">vec</span><span class="p">);</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">plain</span> <span class="o">=</span> <span class="n">decode_single_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipher</span><span class="p">);</span>
</span><span class='line'>        <span class="n">plain</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">()</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">decoded</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">.</span><span class="n">reassemble</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">plain</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">::</span><span class="n">PlainText</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">decoded</span><span class="p">);</span>
</span><span class='line'>    <span class="n">plain</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">pub</span> <span class="k">fn</span> <span class="n">decode_text</span><span class="p">(</span><span class="n">cipher</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">cipher</span><span class="o">::</span><span class="n">CipherText</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">cipher</span><span class="o">::</span><span class="n">PlainText</span><span class="p">,</span> <span class="n">cipher</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">best_score</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">candidate</span> <span class="o">=</span> <span class="nb">None</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">key_size_guesses</span> <span class="o">=</span> <span class="n">guess_key_size</span><span class="p">(</span><span class="n">cipher</span><span class="p">);</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">key_size</span> <span class="k">in</span> <span class="n">key_size_guesses</span><span class="p">.</span><span class="n">iter</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">plain</span> <span class="o">=</span> <span class="n">break_cipher</span><span class="p">(</span><span class="n">cipher</span><span class="p">,</span> <span class="o">*</span><span class="n">key_size</span><span class="p">);</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">score</span> <span class="o">=</span> <span class="n">score</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plain</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_score</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span><span class="p">;</span>
</span><span class='line'>            <span class="n">candidate</span> <span class="o">=</span> <span class="nb">Some</span><span class="p">(</span><span class="n">plain</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">candidate</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">None</span> <span class="o">=&gt;</span> <span class="nb">Err</span><span class="p">(</span><span class="n">cipher</span><span class="o">::</span><span class="n">Error</span><span class="o">::</span><span class="n">Failure</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t decode text&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">())),</span>
</span><span class='line'>        <span class="nb">Some</span><span class="p">(</span><span class="n">plain</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">Ok</span><span class="p">(</span><span class="n">plain</span><span class="p">),</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Just like last time, you can find the full source for this post in my <a href="https://github.com/jagg/vigenere">github account</a>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jose A. Garcia</span></span>

      




<time class='entry-date' datetime='2016-09-14T21:19:45+01:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>9:19 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/crypto/'>crypto</a>, <a class='category' href='/blog/categories/rust/'>rust</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://jagg.github.io/blog/2016/09/14/breaking-the-vigenere-cipher/" data-via="jagarciagim" data-counturl="http://jagg.github.io/blog/2016/09/14/breaking-the-vigenere-cipher/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/09/03/encrypting-like-its-1553/" title="Previous Post: Encrypting like it's 1553">&laquo; Encrypting like it's 1553</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    
<section>
  <h1>About Me</h1>
  <div id="twitter-profile" style="margin-top:0.5em;">
    <p>
      <strong>Jose A. Garcia</strong> 
      (<a href="http://twitter.com/jagarciagim">@jagarciagim</a>)
    </p>
    <p></p>
  </div>
  <script type="text/javascript">
    $(function(){
        var container = $('#twitter-profile'),
            user = "jagarciagim";
        
        function parseTwLinks(s) {
          var twUrl = "http://www.twitter.com/"
          s = s.replace(/ (@([\w]+))/g, function(match, p1, p2) {
              return " <a href='"+twUrl+p2+"'>"+p1+"</a>"
          }).replace(/ (#([\w]+))/g, function(match, p1, p2) {
              return " <a href='"+twUrl+"#!/search?q=%23"+p2+"'>"+p1+"</a>"
          })
          return s
        }

        $.ajax({
            url: "http://api.twitter.com/1/users/show.json?include_entities=false&screen_name="+user+"&callback=?"
          , type: 'GET'
          , dataType: 'jsonp'
          , error: function (err) { $('#twitter-profile').addClass('error');  }
          , success: function(data) {
              container.html('<img class="left" src="http://api.twitter.com/1/users/profile_image/'+user+'.json?size=bigger" alt="@'+user+'"><p><strong>'+data.name+'</strong> (<a href="http://twitter.com/'+user+'">@'+user+'</a>)<br/>'+data.location+'</p><p>'+parseTwLinks(data.description)+'</p>');
            }
        })
      });
  </script>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/09/14/breaking-the-vigenere-cipher/">Breaking the Vigenère Cipher</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/09/03/encrypting-like-its-1553/">Encrypting Like It's 1553</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/jagg">@jagg</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'jagg',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Jose A. Garcia -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
